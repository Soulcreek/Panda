(function(){if(window.Pickers)return;const BASE=(location.pathname.startsWith('/editors'))? '/editors' : '/admin';async function apiFetchJSON(url){try{return await apiFetch(url,{headers:{'Accept':'application/json'}});}catch(e){throw e;}}function buildDialog(opts){const dlg=A11yDialog.create({label: opts.label,className:'picker-dialog',html: `<div class='ap-picker-backdrop' data-backdrop><div class='picker-inner'><header class='d-flex justify-content-between align-items-center mb-2'><strong>${opts.title}</strong><button type='button' class='btn btn-sm btn-outline-secondary' data-close>&times;</button></header><div class='picker-body'>${opts.body||''}</div><div class='picker-footer text-end mt-3'><button type='button' class='btn btn-sm btn-secondary' data-close>Schließen</button></div></div></div>`,closeSelector:'[data-close],[data-backdrop]',backdropClose:true});return dlg;}function media(opts){opts=opts||{};return new Promise((resolve,reject)=>{const dlg=buildDialog({label:'Medienauswahl',title:'Medien',body:`<div class='mb-2 d-flex gap-2'><input type='text' class='form-control form-control-sm picker-filter' placeholder='Filter...'><select class='form-select form-select-sm picker-sort'><option value='recent'>Neueste</option><option value='name'>Name</option></select></div><div class='picker-results'><div class='text-muted small'>Lade...</div></div>`});dlg.on('close',()=>reject('closed'));dlg.mount();const filterEl=dlg.el.querySelector('.picker-filter');const sortEl=dlg.el.querySelector('.picker-sort');let list=[];function draw(){const filter=(filterEl.value||'').toLowerCase();let view=list.filter(i=>!filter ||(i.name||'').toLowerCase().includes(filter)||(i.alt_text||'').toLowerCase().includes(filter));if(sortEl.value==='name')view.sort((a,b)=>(a.name||'').localeCompare(b.name||''));const wrap=dlg.el.querySelector('.picker-results');wrap.innerHTML='';if(!view.length){wrap.innerHTML='<div class="text-muted small">Keine Medien.</div>';return;}const grid=document.createElement('div');grid.className='row g-2';view.forEach(item=>{if(opts.type && !item.type.startsWith(opts.type))return;const col=document.createElement('div');col.className='col-4';const btn=document.createElement('button');btn.type='button';btn.className='btn btn-outline-secondary w-100 p-1 d-flex flex-column align-items-center';btn.innerHTML=`${item.type.startsWith('image')?`<img src='${item.path}' alt='' style='max-width:100%;height:60px;object-fit:cover;'/>`:''}<span class='small text-truncate w-100'>${escapeHtml(item.name||item.path.split('/').pop())}</span>`;btn.addEventListener('click',()=>{dlg.close();resolve(item);});col.appendChild(btn);grid.appendChild(col);});wrap.appendChild(grid);}apiFetchJSON(`${BASE}/api/media${opts.type?`?type=${encodeURIComponent(opts.type)}`:''}`).then(data=>{list=data||[];draw();}).catch(err=>{dlg.el.querySelector('.picker-results').innerHTML='<div class="text-danger small">Fehler: '+escapeHtml(err.message||'Laden')+'</div>';});filterEl.addEventListener('input',draw);sortEl.addEventListener('change',draw);});}function post(){return new Promise((resolve,reject)=>{const dlg=buildDialog({label:'Post auswählen',title:'Posts',body:`<div class='picker-results'><div class='text-muted small'>Lade...</div></div>`});dlg.on('close',()=>reject('closed'));dlg.mount();apiFetchJSON(`${BASE}/api/posts/simple`).then(list=>{const wrap=dlg.el.querySelector('.picker-results');if(!list.length){wrap.innerHTML='<div class="text-muted small">Keine Posts.</div>';return;}wrap.innerHTML='';const ul=document.createElement('div');ul.className='list-group';list.forEach(p=>{const btn=document.createElement('button');btn.type='button';btn.className='list-group-item list-group-item-action';btn.innerHTML=`<strong>${escapeHtml(p.title)}</strong><br><small class='text-muted'>/${escapeHtml(p.slug)}</small>`;btn.addEventListener('click',()=>{dlg.close();resolve(p);});ul.appendChild(btn);});wrap.appendChild(ul);}).catch(err=>{dlg.el.querySelector('.picker-results').innerHTML='<div class="text-danger small">Fehler: '+escapeHtml(err.message||'Laden')+'</div>';});});}function podcast(){return new Promise((resolve,reject)=>{const dlg=buildDialog({label:'Podcast auswählen',title:'Podcasts',body:`<div class='picker-results'><div class='text-muted small'>Lade...</div></div>`});dlg.on('close',()=>reject('closed'));dlg.mount();apiFetchJSON(`${BASE}/api/podcasts/simple`).then(list=>{const wrap=dlg.el.querySelector('.picker-results');if(!list.length){wrap.innerHTML='<div class="text-muted small">Keine Podcasts.</div>';return;}wrap.innerHTML='';const ul=document.createElement('div');ul.className='list-group';list.forEach(p=>{const btn=document.createElement('button');btn.type='button';btn.className='list-group-item list-group-item-action';btn.innerHTML=`<strong>${escapeHtml(p.title)}</strong>`;btn.addEventListener('click',()=>{dlg.close();resolve(p);});ul.appendChild(btn);});wrap.appendChild(ul);}).catch(err=>{dlg.el.querySelector('.picker-results').innerHTML='<div class="text-danger small">Fehler: '+escapeHtml(err.message||'Laden')+'</div>';});});}function escapeHtml(str){return(str||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]||c));}window.Pickers={media,post,podcast};})();