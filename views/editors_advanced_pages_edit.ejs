<%- include('partials/header') %>
<%- include('partials/editors_nav') %>
<div class="container" data-aos="fade-in">
  <h1 class="h3 mb-4"><%= page? 'Advanced Page bearbeiten' : 'Neue Advanced Page' %></h1>
  <form method="POST" action="/editors/advanced-pages/save" id="advancedPageForm">
    <input type="hidden" name="id" value="<%= page? page.id:'' %>">
    <div class="mb-3">
      <label class="form-label">Titel</label>
      <input type="text" class="form-control" name="title" id="apTitle" value="<%= page? page.title:'' %>" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Slug</label>
      <input type="text" class="form-control" name="slug" id="apSlug" value="<%= page? page.slug:'' %>" required>
    </div>
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label class="form-label">SEO Title</label>
        <input type="text" class="form-control" name="seo_title" maxlength="255" value="<%= page? (page.seo_title||''):'' %>">
      </div>
      <div class="col-md-6">
        <label class="form-label">Meta Keywords (Komma getrennt)</label>
        <input type="text" class="form-control" name="meta_keywords" maxlength="255" value="<%= page? (page.meta_keywords||''):'' %>">
      </div>
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <label class="form-label mb-0">SEO Description</label>
          <button type="button" id="apSeoAuto" class="btn btn-sm btn-outline-secondary">Ableiten</button>
        </div>
        <textarea class="form-control" id="apSeoDesc" name="seo_description" rows="2" maxlength="255"><%= page? (page.seo_description||''):'' %></textarea>
        <div class="form-text d-flex justify-content-between"><span>Kurze Beschreibung (155-180 empfohlen)</span><span id="apSeoDescCounter" class="small text-muted"></span></div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Meta Image URL</label>
        <input type="text" class="form-control" name="meta_image" value="<%= page? (page.meta_image||''):'' %>">
        <div class="form-text">Optionales Vorschaubild (absoluter oder relativer Pfad)</div>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2 mb-3">
      <button type="button" class="btn btn-sm btn-outline-primary ap-add-row" data-preset="full">+ Full</button>
      <button type="button" class="btn btn-sm btn-outline-primary ap-add-row" data-preset="two-equal">+ 50/50</button>
      <button type="button" class="btn btn-sm btn-outline-primary ap-add-row" data-preset="two-67-33">+ 67/33</button>
      <button type="button" class="btn btn-sm btn-outline-primary ap-add-row" data-preset="two-33-67">+ 33/67</button>
      <button type="button" class="btn btn-sm btn-outline-primary ap-add-row" data-preset="three">+ 3 Col</button>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="apExpandAll">Expand</button>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="apCollapseAll">Collapse</button>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="apJSONToggle">Layout JSON</button>
    </div>
    <div id="apBuilder" class="mb-4"></div>
    <div class="mb-3 d-none" id="apJsonWrapper">
      <label class="form-label">Layout JSON (editierbar)</label>
      <textarea class="form-control font-monospace" rows="10" id="apJsonTextarea"></textarea>
    </div>
    <input type="hidden" name="layout_json" id="apLayoutInput">
    <div class="form-check form-switch mb-3">
      <input class="form-check-input" type="checkbox" id="apMakeTemplate" name="make_template" value="1" <%= page && page.is_template? 'checked':'' %>>
      <label class="form-check-label" for="apMakeTemplate">Als Template speichern</label>
    </div>
    <div class="mb-3">
      <label class="form-label">Status</label>
      <select class="form-select" name="status">
        <option value="draft" <%= !page || page.status==='draft' ? 'selected' : '' %>>Draft</option>
        <option value="published" <%= page && page.status==='published' ? 'selected' : '' %>>Published</option>
      </select>
      <div class="form-text">Veröffentlichte Seiten erscheinen unter <code>/pages/&lt;slug&gt;</code>.</div>
    </div>
    <div class="mb-5">
  <button class="btn btn-success">Speichern</button>
  <button type="button" id="apResetBtn" class="btn btn-outline-danger ms-2">Zurücksetzen</button>
  <a href="/editors/advanced-pages" class="btn btn-outline-secondary ms-2">Zurück</a>
    </div>
  </form>
</div>
<div id="apLayoutData" data-json="<%= encodeURIComponent(layoutJSON) %>"></div>
<div id="apDataPosts" data-json="<%= encodeURIComponent(JSON.stringify(typeof posts!=='undefined'?posts:[])) %>"></div>
<div id="apDataPodcasts" data-json="<%= encodeURIComponent(JSON.stringify(typeof podcasts!=='undefined'?podcasts:[])) %>"></div>
<script nonce="<%= cspNonce %>">
(function(){
  function parse(id){ try { var el=document.getElementById(id); if(!el) return []; return JSON.parse(decodeURIComponent(el.getAttribute('data-json')||'%5B%5D')); } catch(_){ return []; } }
  window.__AP_PRE_POSTS = parse('apDataPosts');
  window.__AP_PRE_PODCASTS = parse('apDataPodcasts');
})();
</script>
<script nonce="<%= cspNonce %>">
(function(){
  const btn = document.getElementById('apResetBtn');
  if(!btn) return;
  btn.addEventListener('click', ()=>{
    if(!confirm('Formular zurücksetzen? Alle ungespeicherten Änderungen gehen verloren. Fortfahren?')) return;
    try{
      // Clear main inputs
      ['apTitle','apSlug','apSeoDesc'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      // Uncheck template flag
      const tpl = document.getElementById('apMakeTemplate'); if(tpl) tpl.checked = false;
      // Reset status selector to draft
      const status = document.querySelector('select[name="status"]'); if(status) status.value='draft';
      // Clear hidden layout input
      const layoutInput = document.getElementById('apLayoutInput'); if(layoutInput) layoutInput.value = JSON.stringify({version:2,rows:[]});
      // Remove autosave drafts
      try{ Object.keys(localStorage).filter(k=>k && k.indexOf('ap_draft')===0).forEach(k=>localStorage.removeItem(k)); }catch(_){ }
    }catch(_){ }
    // Reload so the builder initializes clean for new pages (and picks up server state for edits)
    location.reload();
  });
})();
</script>
<script nonce="<%= cspNonce %>">(function(){ try { var el=document.getElementById('apLayoutData'); window.__AP_INITIAL_LAYOUT = JSON.parse(decodeURIComponent(el.getAttribute('data-json'))); } catch(e){ window.__AP_INITIAL_LAYOUT={version:2,rows:[]}; } })();</script>
<link rel="stylesheet" href="/css/advanced_pages.css">
<script src="/js/a11y.js"></script>
<script src="/js/advanced_pages_builder.js"></script>
<script nonce="<%= cspNonce %>">
(function(){
  const seoBtn=document.getElementById('apSeoAuto');
  const desc=document.getElementById('apSeoDesc');
  const counter=document.getElementById('apSeoDescCounter');
  function upd(){ if(!desc||!counter) return; const len=(desc.value||'').length; counter.textContent=len+' / 180'; counter.classList.toggle('text-danger', len>180); }
  if(desc){ desc.addEventListener('input',upd); upd(); }
  if(seoBtn){ seoBtn.addEventListener('click',()=>{ if(!desc.value){ try { // naive derive from first text block
        var raw='';
        (window.__AP_INITIAL_LAYOUT?.rows||[]).some(r=> (r.columns||[]).some(c=> (c.blocks||[]).some(b=>{ if((b.type==='text'||b.type==='html') && b.html){ raw=b.html.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim(); return true; } return false; }))); 
        desc.value=raw.slice(0,170); if(desc.value.lastIndexOf('.')>60) desc.value=desc.value.slice(0, desc.value.lastIndexOf('.')+1); upd(); } catch(_){ } } }); }
})();
</script>
<%- include('partials/footer') %>
