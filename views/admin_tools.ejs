<%- include('partials/header') %>
<%- include('partials/admin_nav') %>
<div class="admin-container container my-5">
    <h2 class="mb-4">Werkzeuge &amp; Debug</h2>
    <p class="text-muted">Dateninspektion & Diagnose (<code><%= mode %></code>).</p>
    <% if(debug){ %>
        <div class="alert alert-info py-2 small mb-3">
            <strong>Debug Modus aktiv.</strong>
            <% if(errors && errors.length){ %>
                <ul class="mb-0 small">
                <% errors.forEach(e=>{ %><li><code><%= e %></code></li><% }); %>
                </ul>
            <% } else { %>
                <span>Keine Fehler protokolliert.</span>
            <% } %>
        </div>
        <div class="mb-3">
            <div class="btn-group" role="group" aria-label="Diagnostics">
                <button id="diagBtn" class="btn btn-sm btn-outline-primary">Run DB Diag</button>
                <button id="uploadsBtn" class="btn btn-sm btn-outline-secondary">List Uploads</button>
            </div>
            <div id="diagOutput" class="mt-3"><pre class="small bg-light p-2 rounded" id="diagPre">Console output will appear here.</pre></div>
        </div>
    <% } %>

    <% if(!debug && (mode==='raw' || mode==='tables')){ %>
        <div class="mb-3">
            <div class="alert alert-warning small mb-2">Keine Daten sichtbar? Führe die Diagnose aus, um DB-User/Schema zu prüfen.</div>
            <div class="btn-group" role="group" aria-label="Diagnostics">
                <button id="diagBtn" class="btn btn-sm btn-outline-primary">Run DB Diag</button>
                <button id="uploadsBtn" class="btn btn-sm btn-outline-secondary">List Uploads</button>
            </div>
            <div id="diagOutput" class="mt-3"><pre class="small bg-light p-2 rounded" id="diagPre"></pre></div>
        </div>
    <% } %>

    <% if(mode==='structured'){ %>
        <h4 class="mt-4">Beiträge (letzte <%= posts.length %>)</h4>
        <div class="table-responsive mb-4">
            <table class="table table-sm table-hover align-middle">
                <thead class="table-light"><tr><th>ID</th><th>Titel</th><th>Status</th><th>Featured</th><th>Gelöscht</th><th>Publiziert</th></tr></thead>
                <tbody>
                <% if(posts.length){ posts.forEach(p=>{ %>
                    <tr><td><%= p.id %></td><td><%= p.title %></td><td><span class="badge bg-<%= p.is_visible?'success':'secondary' %>"><%= p.is_visible?'published':'draft' %></span></td><td><%= p.is_featured?'⭐':'' %></td><td><%= p.is_deleted?'Ja':'-' %></td><td><%= p.published_at? new Date(p.published_at).toISOString().slice(0,16).replace('T',' '):'-' %></td></tr>
                <% }); } else { %><tr><td colspan="6" class="text-center text-muted">Keine Beiträge</td></tr><% } %>
                </tbody>
            </table>
        </div>
        <h4 class="mt-4">Podcasts (letzte <%= podcasts.length %>)</h4>
        <div class="table-responsive mb-4">
            <table class="table table-sm table-hover align-middle">
                <thead class="table-light"><tr><th>ID</th><th>Titel</th><th>SEO Titel</th><th>Publiziert</th></tr></thead>
                <tbody>
                <% if(podcasts.length){ podcasts.forEach(r=>{ %>
                    <tr><td><%= r.id %></td><td><%= r.title %></td><td><%= r.seo_title||'-' %></td><td><%= r.published_at? new Date(r.published_at).toISOString().slice(0,10):'-' %></td></tr>
                <% }); } else { %><tr><td colspan="4" class="text-center text-muted">Keine Podcasts</td></tr><% } %>
                </tbody>
            </table>
        </div>
        <h4 class="mt-4">Advanced Pages (letzte <%= pages.length %>)</h4>
        <div class="table-responsive mb-4">
            <table class="table table-sm table-hover align-middle">
                <thead class="table-light"><tr><th>ID</th><th>Titel</th><th>Slug</th><th>Status</th><th>Template</th><th>Updated</th></tr></thead>
                <tbody>
                <% if(pages.length){ pages.forEach(r=>{ %>
                    <tr><td><%= r.id %></td><td><%= r.title %></td><td><code><%= r.slug %></code></td><td><span class="badge bg-secondary"><%= r.status %></span></td><td><%= r.is_template? 'Ja':'-' %></td><td><%= r.updated_at? r.updated_at.toISOString().slice(0,16).replace('T',' '):'' %></td></tr>
                <% }); } else { %><tr><td colspan="6" class="text-center text-muted">Keine Seiten</td></tr><% } %>
                </tbody>
            </table>
        </div>
    <% } else if(mode==='raw'){ %>
        <% if(!tables.length){ %>
            <div class="alert alert-warning small">Keine Tabellen gefunden oder DB leer. (SHOW TABLES Ergebnis leer)</div>
        <% } else { %>
            <ul class="nav nav-pills mb-3 flex-wrap" id="rawTabs">
                <% tables.forEach(function(t,i){ const cnt = (rawData && rawData[t])? (rawData[t].length||0) : 0; %>
                    <li class="nav-item"><button class="nav-link <%= i===0? 'active':'' %>" data-bs-toggle="tab" data-bs-target="#raw-<%= t %>" type="button"><%= t %> <span class="badge bg-secondary ms-2"><%= cnt %></span></button></li>
                <% }); %>
            </ul>
            <div class="tab-content border rounded bg-light scroll-mh-560" id="rawTabContent">
                <% tables.forEach(function(t,i){ const data = rawData[t]||[]; %>
                    <div class="tab-pane fade <%= i===0? 'show active':'' %> p-3" id="raw-<%= t %>">
                        <h5 class="mb-3"><%= t %> <small class="text-muted">(<%= data.length %> Zeilen)</small></h5>
                        <% if(!data.length){ %>
                            <div class="text-muted small fst-italic">Leer (0 Zeilen)</div>
                        <% } %>
                        <pre class="small bg-dark text-light p-2 rounded scroll-mh-480"><code><%- JSON.stringify(data, null, 2) %></code></pre>
                    </div>
                <% }); %>
            </div>
        <% } %>
    <% } %>
</div>
<script nonce="<%= cspNonce %>">
document.addEventListener('DOMContentLoaded',()=>{
    const diagBtn = document.getElementById('diagBtn');
    const uploadsBtn = document.getElementById('uploadsBtn');
    const out = document.getElementById('diagPre');
    if(diagBtn) diagBtn.addEventListener('click', async ()=>{
        out.textContent = 'Calling /admin/tools/diag ...';
        try{ const r = await fetch('/admin/tools/diag'); const j = await r.json(); out.textContent = JSON.stringify(j,null,2); }catch(e){ out.textContent = 'Error: '+e.message; }
    });
    if(uploadsBtn) uploadsBtn.addEventListener('click', async ()=>{
        out.textContent = 'Calling /admin/tools/uploads ...';
        try{ const r = await fetch('/admin/tools/uploads'); const j = await r.json(); out.textContent = JSON.stringify(j,null,2); }catch(e){ out.textContent = 'Error: '+e.message; }
    });
});
</script>
<%- include('partials/footer') %>
