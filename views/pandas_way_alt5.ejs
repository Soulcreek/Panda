<%- include('partials/header') %>
<%- include('partials/admin_nav') %>
<div class="container-fluid px-0" id="alt5Root" data-fallback-levels="<%- (timelineSiteConfig && timelineSiteConfig.level_count) ? timelineSiteConfig.level_count : 0 %>" data-entry-count="<%= (entries && entries.length) ? entries.length : 0 %>">
  <section class="py-5 text-center position-relative alt5-hero text-light">
    <div class="container">
      <h1 class="display-4 fw-bold mb-3">Panda's Way – ALT Design 5</h1>
      <p class="lead mb-4">Glass Navigation + Dynamische Timeline (DB).</p>
  <div class="d-flex justify-content-center flex-wrap gap-3 mb-4" id="alt5Controls" aria-label="Timeline Level Navigation"></div>
  <!-- Edit Button entfernt; stattdessen Level-Kacheln -->
    </div>
    <div class="alt5-bg-layer"></div>
  </section>
  <section class="container position-relative py-5" id="alt5Content">
    <div id="alt5LevelPrompt" class="text-center text-light mb-5">
      <div class="h4 fw-semibold mb-3">Wähle ein Level um zu starten</div>
      <p class="lead mb-0" style="font-size:1.05rem;opacity:.85;">Die Inhalte sind alternative Pfade. Entscheide dich für das Level, das zu deinem Reifegrad passt.</p>
    </div>
    <div class="mb-4 small text-muted" id="alt5DebugSummary">
      <strong>Debug:</strong>
      Levels (config): <%= (timelineSiteConfig && timelineSiteConfig.level_count) ? timelineSiteConfig.level_count : 'n/a' %> |
      Entries: <%= (entries && entries.length) ? entries.length : 0 %>
      <% if(!(entries && entries.length)){ %>
        <span class="text-danger">(Keine Einträge gerendert – Seed sollte beim ersten Aufruf erzeugt werden. Prüfe DB-Verbindung & Konsole.)</span>
      <% } %>
    </div>
    <% if(entries && entries.length){ %>
  <ul class="alt5-timeline list-unstyled m-0 p-0" data-initial-hidden="1">
        <% entries.forEach(function(item){ 
             var lvl = (item.level || 1);
             var lvlMeta = (timelineLevels||[]).find(l=>l.level_index===lvl) || null;
        %>
          <li class="alt5-item" data-pos="<%= item.position %>" data-level="<%= lvl %>">
            <div class="alt5-bubble">
              <div class="d-flex justify-content-between align-items-start flex-wrap mb-2">
                <div class="small text-uppercase fw-semibold text-warning"><%= item.phase || '' %></div>
                <span class="alt5-level-badge">
                  <% if(lvlMeta && lvlMeta.icon){ %><i class="bi <%= lvlMeta.icon %> me-1"></i><% } %>
                  <%= lvlMeta && lvlMeta.title ? lvlMeta.title : ('Level '+lvl) %>
                </span>
              </div>
              <h2><%= item.title %></h2>
              <div class="alt5-divider"></div>
              <div class="alt5-html"><%- item.content_html || '' %></div>
            </div>
          </li>
        <% }); %>
      </ul>
    <% } else { %>
      <div class="alert alert-info">Noch keine Timeline-Einträge vorhanden.</div>
    <% } %>
  </section>
</div>
<style>
.alt5-hero{background:linear-gradient(135deg,#111,#222);overflow:hidden;position:relative;z-index:0;}
.alt5-hero > .container{position:relative;z-index:2;}
.alt5-bg-layer{position:absolute;inset:0;opacity:.4;background:radial-gradient(circle at 70% 30%,rgba(99,102,241,.35),transparent 60%);z-index:1;pointer-events:none;} 
.alt5-timeline{position:relative;margin:0;padding:0;}
.alt5-timeline:before{content:"";position:absolute;left:50%;top:0;bottom:0;width:4px;background:linear-gradient(#6366f1,#8b5cf6);transform:translateX(-50%);} 
.alt5-item{position:relative;width:50%;padding:2.5rem 2rem;box-sizing:border-box;display:none;}
.alt5-item:nth-child(odd){left:0;text-align:right;}
.alt5-item:nth-child(even){left:50%;}
.alt5-bubble{background:#fff;border-radius:1.25rem;padding:1.75rem 1.5rem;box-shadow:0 1.5rem 2.75rem -1.25rem rgba(0,0,0,.25);display:inline-block;max-width:520px;position:relative;opacity:0;transform:translateY(60px) scale(.95);transition:opacity .85s ease, transform .95s cubic-bezier(.16,.8,.28,.96);} 
.alt5-bubble.reveal{opacity:1;transform:translateY(0) scale(1);} 
.alt5-bubble:before{content:"";position:absolute;top:1.2rem;width:16px;height:16px;border-radius:50%;background:#6366f1;box-shadow:0 0 0 6px #6366f155;} 
.alt5-item:nth-child(odd) .alt5-bubble:before{right:-42px;} .alt5-item:nth-child(even) .alt5-bubble:before{left:-42px;} 
.alt5-bubble h2{font-size:1.6rem;font-weight:600;background:linear-gradient(90deg,#6366f1,#8b5cf6,#6366f1);-webkit-background-clip:text;background-clip:text;color:transparent;margin-bottom:.6rem;} 
.alt5-divider{height:4px;width:120px;background:linear-gradient(90deg,#6366f1,#8b5cf6,#6366f1);border-radius:3px;margin:.5rem 0 1.25rem 0;} 
/* Level Badge */
.alt5-level-badge{background:linear-gradient(135deg,#1e1e2f,#2d2d42);color:#fff;font-size:.65rem;letter-spacing:.5px;padding:.35rem .7rem;border-radius:1rem;box-shadow:0 0 0 1px rgba(255,255,255,.08),0 4px 10px -3px rgba(0,0,0,.4);text-transform:uppercase;white-space:nowrap;}
/* Glass Level Navigation */
#alt5Controls.glass-nav{background:rgba(255,255,255,.12);padding:.85rem 1.4rem;border-radius:2.5rem;backdrop-filter:blur(18px) saturate(160%);-webkit-backdrop-filter:blur(18px) saturate(160%);box-shadow:0 6px 28px -8px rgba(0,0,0,.55),0 0 0 1px rgba(255,255,255,.15) inset;position:relative;}
#alt5Controls.glass-nav:before{content:"";position:absolute;inset:0;border-radius:inherit;background:linear-gradient(135deg,rgba(255,255,255,.25),rgba(255,255,255,.07));mix-blend-mode:overlay;pointer-events:none;}
#alt5Controls .alt5-level-btn{border:0;background:rgba(255,255,255,.18);color:#fff;backdrop-filter:inherit;-webkit-backdrop-filter:inherit;border-radius:2rem;padding:.55rem 1.15rem;font-weight:500;letter-spacing:.5px;display:inline-flex;align-items:center;gap:.5rem;position:relative;overflow:hidden;transition:background .35s, color .35s, box-shadow .4s, transform .35s;}
#alt5Controls .alt5-level-btn .alt5-level-thumb-wrap{width:30px;height:30px;flex:0 0 30px;border-radius:50%;overflow:hidden;position:relative;box-shadow:0 0 0 2px rgba(255,255,255,.25);}
#alt5Controls .alt5-level-btn .alt5-level-thumb{width:100%;height:100%;object-fit:cover;display:block;}
#alt5Controls .alt5-level-btn .alt5-level-thumb-wrap:before{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(99,102,241,.35),rgba(0,0,0,.25));mix-blend-mode:overlay;}
#alt5Controls .alt5-level-btn:before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 30% 20%,rgba(255,255,255,.35),transparent 65%);opacity:.0;transition:opacity .4s;}
#alt5Controls .alt5-level-btn:hover:before{opacity:.6;}
#alt5Controls .alt5-level-btn:hover{background:rgba(255,255,255,.3);}
#alt5Controls .alt5-level-btn.active{background:linear-gradient(135deg,#6366f1,#8b5cf6);box-shadow:0 0 0 3px rgba(255,255,255,.25),0 10px 22px -6px rgba(99,102,241,.6);}
#alt5Controls .alt5-level-btn.active:before{opacity:.85;}
#alt5Controls .alt5-level-btn:focus-visible{outline:2px solid #fff;outline-offset:2px;}
@supports not ((backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px))){
  #alt5Controls.glass-nav{background:rgba(40,40,50,.75);} 
}
@media (max-width: 880px){
  .alt5-timeline:before{left:8px;} 
  .alt5-item,.alt5-item:nth-child(even),.alt5-item:nth-child(odd){width:100%;left:0;text-align:left;padding:2.25rem 0 2.25rem 2.5rem;} 
  .alt5-bubble{max-width:100%;}
  .alt5-bubble:before{left:-38px !important;right:auto;}
}
</style>
<script>
(function(){
  console.log('alt5 init');
  var rootEl = document.getElementById('alt5Root');
  var fallbackCount = parseInt(rootEl ? rootEl.getAttribute('data-fallback-levels') : '0',10) || 0;
  var entryCount = parseInt(rootEl ? rootEl.getAttribute('data-entry-count') : '0',10) || 0;
  if(entryCount===0){
    console.warn('[ALT5] Keine Entries auf der Seite vorhanden. Erwartet wurde Seed-Erstellung serverseitig.');
  }
  function buildLevelNav(){
    var cont=document.getElementById('alt5Controls'); if(!cont) return;
    // Bereits aufgebaut?
    if(cont.dataset.built==='1') return;
    var cfg={ level_count: fallbackCount, design_theme:'glass' }; var levels=[];
    var levelDataScript=document.getElementById('alt5LevelData');
    if(levelDataScript){
      try { var payload=JSON.parse(levelDataScript.textContent||'{}'); cfg=payload.config||cfg; levels=payload.levels||[]; } catch(e){ console.warn('Parse alt5LevelData fail', e); }
    }
    if(cfg.level_count>0){
      if(cfg.design_theme==='glass') cont.classList.add('glass-nav');
      for(var i=1;i<=cfg.level_count;i++){
  var meta = levels.find(l=>l.level_index===i) || { title:'Level '+i };
  var btn=document.createElement('button'); btn.type='button'; btn.className='alt5-level-btn'; btn.dataset.level=i; btn.setAttribute('aria-pressed','false');
  var imgPart = meta && meta.image_path ? '<span class="alt5-level-thumb-wrap"><img src="'+meta.image_path+'" alt="L'+i+'" class="alt5-level-thumb" loading="lazy"></span>' : '';
  var iconPart = (!imgPart && meta && meta.icon) ? '<i class="bi '+meta.icon+' me-1"></i>' : '';
  btn.innerHTML= imgPart + iconPart + '<span class="fw-semibold">'+(meta.title||('Level '+i))+'</span>';
  cont.appendChild(btn);
      }
      function ensureNoContentMsg(){
        var existing=document.getElementById('alt5NoContentMsg');
        if(existing) existing.remove();
        var msg=document.createElement('div'); msg.id='alt5NoContentMsg'; msg.className='alert alert-warning text-center mt-4'; msg.textContent='Keine Einträge für dieses Level.'; document.getElementById('alt5Content').appendChild(msg);
      }
      function activateLevel(targetLevel, btn){
        // Toggle button states
        document.querySelectorAll('.alt5-level-btn').forEach(x=>{ const act = x===btn; x.classList.toggle('active', act); x.setAttribute('aria-pressed', act?'true':'false'); });
        // Show only matching items
        var anyShown=false;
        document.querySelectorAll('.alt5-item').forEach(function(li){
          if(parseInt(li.dataset.level||'1',10)===targetLevel){
            // WICHTIG: display auf einen sichtbaren Wert setzen ('' ließ CSS-Regel .alt5-item{display:none} aktiv)
            li.style.display='block';
            anyShown=true;
          } else {
            li.style.display='none';
          }
        });
        // Remove prompt after first selection
        var prompt=document.getElementById('alt5LevelPrompt'); if(prompt){ prompt.remove(); }
        // Remove old no-content message
        var oldMsg=document.getElementById('alt5NoContentMsg'); if(oldMsg) oldMsg.remove();
        if(!anyShown){ ensureNoContentMsg(); }
        // Re-run observer for visible items
        observe(); immediateReveal();
        // Scroll
        window.scrollTo({ top: document.getElementById('alt5Content').offsetTop - 40, behavior:'smooth'});
      }
  cont.addEventListener('click', function(e){
        var b=e.target.closest('.alt5-level-btn'); if(!b) return; var targetLevel=parseInt(b.dataset.level,10); activateLevel(targetLevel, b);
      });
      // Auto-Select Logik: Query ?level=, ansonsten wenn mehrere Levels: aktiviere Level 1 direkt falls Einträge vorhanden
      var qp = new URLSearchParams(window.location.search).get('level');
      var target = null;
      if(qp){
        var L = parseInt(qp,10); if(L>=1 && L<=cfg.level_count) target=L; else console.warn('[ALT5] Ungültiger level Query Parameter:', qp);
      } else if(cfg.level_count>=1 && entryCount>0){
        target = 1;
      }
      if(target){
        var btnCandidate = cont.querySelector('.alt5-level-btn[data-level="'+target+'"]');
        if(btnCandidate) activateLevel(target, btnCandidate); else console.warn('[ALT5] Konnte Auto-Activate Button für Level', target, 'nicht finden.');
      }
      cont.dataset.built='1';
    }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', buildLevelNav); else buildLevelNav();
  // Intersection Animation
  const io=new IntersectionObserver(es=>es.forEach(en=>{ if(en.isIntersecting){ const b=en.target.querySelector('.alt5-bubble'); if(b){ const d=en.target.dataset.delay||0; b.style.transitionDelay=d+'ms'; b.classList.add('reveal'); } io.unobserve(en.target);} }),{threshold:.25});
  function observe(){ document.querySelectorAll('.alt5-item:not(.obs)').forEach((b,i)=>{ b.classList.add('obs'); b.dataset.delay=90*i; io.observe(b); }); }
  function immediateReveal(){ const vh=window.innerHeight||document.documentElement.clientHeight; const items=document.querySelectorAll('.alt5-item'); if(!items.length){ console.log('Keine alt5-item Elemente zum Anzeigen'); } items.forEach(el=>{ const r=el.getBoundingClientRect(); if(r.top<vh*0.9){ const b=el.querySelector('.alt5-bubble'); if(!b){ console.warn('Fehlendes .alt5-bubble in item',el); } if(b && !b.classList.contains('reveal')){ const d=el.dataset.delay||0; b.style.transitionDelay=d+'ms'; b.classList.add('reveal'); } }}); }
  // Diagnose: Anzahl der gerenderten Items & Levels
  (function diag(){ const items=document.querySelectorAll('.alt5-item'); const levels=new Set(); items.forEach(i=>levels.add(i.dataset.level)); console.log('[ALT5] Items:', items.length, 'Levels found:', Array.from(levels).join(',')); if(!items.length){ console.log('[ALT5] Suggestion: Prüfe Route /pandas-way-alt5 für Seed-Einträge oder DB-Verbindung.'); } })();
  if(!document.querySelector('.alt5-item')){ console.log('Debug: entries Array serverseitig leer oder nicht gerendert.'); }
  observe(); immediateReveal();
})();
</script>
<% /* Level & Config JSON Einbetten (Server muss site config & levels mitliefern) */ %>
<script type="application/json" id="alt5LevelData"><%- JSON.stringify({ config: typeof timelineSiteConfig!=='undefined'? timelineSiteConfig : {}, levels: typeof timelineLevels!=='undefined'? timelineLevels : [] }) %></script>
<%- include('partials/footer') %>
