<%- include('partials/header') %>
<%- include('partials/admin_nav') %>
<div class="container my-5 admin-dashboard">
    <h1 class="h3 mb-3">Admin Dashboard</h1>
    <p class="text-muted small mb-4">Operative Kennzahlen & Systemstatus. Inhaltspflege im Editors Center.</p>
    <div class="row g-4 mb-4">
        <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100"><div class="card-body small d-flex flex-column">
                <div class="text-muted">AI Nutzung (heute)</div>
                <div class="h2 mb-1"><%= aiCallsToday %></div>
                <div class="small text-muted">Limit <%= aiLimit %> (<%= usagePercent %>% )</div>
                <a class="btn btn-sm btn-outline-primary mt-auto" href="/admin/ai-usage">Details</a>
            </div></div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100"><div class="card-body small d-flex flex-column" id="httpMetricsCard">
                <div class="text-muted">HTTP Status</div>
                <div class="h2 mb-1" id="httpOkCnt">–</div>
                <div class="small text-muted" id="httpErrCnt">Err: – / –</div>
                <button class="btn btn-sm btn-outline-secondary mt-auto" type="button" id="refreshMetricsBtn">Refresh</button>
            </div></div>
        </div>
            <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100"><div class="card-body small d-flex flex-column">
                    <div class="text-muted">Generator Logs (3T)</div>
                <div class="h2 mb-1"><%= genLogCount %></div>
                <div class="small text-muted">Advanced Pages</div>
                <a class="btn btn-sm btn-outline-secondary mt-auto" href="/editors/advanced-pages/generator">Generator</a>
            </div></div>
        </div>
            <div class="col-sm-6 col-lg-3">
                <div class="card shadow-sm h-100"><div class="card-body small d-flex flex-column">
                    <div class="text-muted">AI Parse Errors (3T)</div>
                    <div class="h2 mb-1"><%= parseErrorCount %></div>
                    <div class="small text-muted">Parsing Failures</div>
                    <a class="btn btn-sm btn-outline-secondary mt-auto" href="/admin/ai-usage">Analyse</a>
                </div></div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="card shadow-sm h-100"><div class="card-body small d-flex flex-column">
                    <div class="text-muted">Medien Uploads (3T)</div>
                    <div class="h2 mb-1"><%= mediaUploads3d %></div>
                    <div class="small text-muted">Neue Dateien</div>
                    <a class="btn btn-sm btn-outline-secondary mt-auto" href="/editors/media">Medien</a>
                </div></div>
            </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100"><div class="card-body small d-flex flex-column">
                <div class="text-muted">Veröffentlicht (Heute)</div>
                <div class="h2 mb-1"><%= postsPublishedToday %></div>
                <div class="small text-muted">Beiträge</div>
                <a class="btn btn-sm btn-outline-secondary mt-auto" href="/editors/posts">Beiträge</a>
            </div></div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100"><div class="card-body small d-flex flex-column">
                <div class="text-muted">Entwürfe / Review</div>
                <div class="h2 mb-1"><%= draftsCount %></div>
                <div class="small text-muted">Unveröffentlicht</div>
                <a class="btn btn-sm btn-outline-secondary mt-auto" href="/editors/posts?filter=drafts">Ansehen</a>
            </div></div>
        </div>
    </div>
    <div class="row g-4 mb-4">
        <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100"><div class="card-body small d-flex flex-column">
                <div class="text-muted">DB Health</div>
                <% if (dbHealth) { %>
                    <div class="h6 mb-1"><%= dbHealth.lastPingMs!==null? dbHealth.lastPingMs+'ms' : 'n/a' %> / Ø <%= dbHealth.rollingAvgMs||'?' %>ms</div>
                    <div class="small <%= dbHealth.degraded? 'text-warning':'text-muted' %>">Slow: <%= dbHealth.slowQueries %>/<%= dbHealth.totalQueries %></div>
                    <div class="small <%= dbHealth.lastError? 'text-danger':'text-muted' %>"><%= dbHealth.lastError? ('Err: '+dbHealth.lastError.slice(0,40)) : 'OK' %></div>
                <% } else { %>
                    <div class="small">Keine Daten</div>
                <% } %>
                <button class="btn btn-sm btn-outline-secondary mt-auto" id="dbPingBtnLocal">Ping</button>
            </div></div>
        </div>
        <div class="col-lg-9">
            <div class="card shadow-sm h-100"><div class="card-body small d-flex flex-column">
                <h5 class="card-title mb-2">Hinweise</h5>
                <ul class="small mb-3 ps-3">
                    <li>AI Konfiguration & Limits unter Blog Config verwalten.</li>
                    <li>Parsing / Prompt Experimente über Prompt Tester.</li>
                    <li>Inhaltspflege & Timeline nur im Editors Center.</li>
                </ul>
                <a href="/editors" class="btn btn-sm btn-primary mt-auto align-self-start">Zum Editors Center</a>
            </div></div>
        </div>
    </div>
</div>
<style nonce="<%= cspNonce %>">
html.dark-mode .card{background:linear-gradient(135deg,#1e1e1e,#191b1d);border-color:#2a2f36;}
.admin-dashboard .h2{font-size:1.9rem;}
</style>
<script nonce="<%= cspNonce %>">
document.getElementById('dbPingBtnLocal')?.addEventListener('click',async()=>{try{await fetch('/admin/api/db-health?force=1');location.reload();}catch(_){}});
async function loadHttpMetrics(){
    try {
        const r = await fetch('/admin/api/metrics-summary');
        if(!r.ok) return;
        const j = await r.json();
        document.getElementById('httpOkCnt').textContent = j.ok ?? 0;
        document.getElementById('httpErrCnt').textContent = `4xx:${j.clientErr||0} / 5xx:${j.serverErr||0}`;
    } catch(_){}
}
document.getElementById('refreshMetricsBtn')?.addEventListener('click', ()=> loadHttpMetrics());
loadHttpMetrics();
setInterval(loadHttpMetrics, 15000);
</script>
<%- include('partials/footer') %>
