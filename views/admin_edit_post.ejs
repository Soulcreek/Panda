<%- include('partials/header') %>
<%- include('partials/admin_nav') %>

<div class="container my-5">
    <h1><%= post ? 'Beitrag bearbeiten' : 'Neuen Beitrag erstellen' %></h1>

    <form action="<%= post ? '/admin/posts/edit/' + post.id : '/admin/posts/new' %>" method="POST">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        
        <div class="row">
            <!-- Haupt-Editorbereich -->
            <div class="col-md-8">
                <!-- Tabs für Sprachen -->
                <ul class="nav nav-tabs" id="langTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="de-tab" data-bs-toggle="tab" data-bs-target="#de-pane" type="button" role="tab">Deutsch</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="en-tab" data-bs-toggle="tab" data-bs-target="#en-pane" type="button" role="tab">Englisch</button>
                    </li>
                </ul>

                <div class="tab-content border border-top-0 p-3 mb-3">
                    <!-- Deutscher Inhalt -->
                    <div class="tab-pane fade show active" id="de-pane" role="tabpanel">
                        <div class="mb-3">
                            <label for="title_de" class="form-label">Titel (DE)</label>
                            <input type="text" class="form-control" id="title_de" name="title" value="<%= post ? post.title : '' %>" required>
                        </div>
                        <div class="mb-3">
                            <label for="content_de" class="form-label">Inhalt (DE)</label>
                            <textarea class="form-control" id="content_de" name="content" rows="15"><%= post ? post.content : '' %></textarea>
                        </div>
                    </div>
                    <!-- Englischer Inhalt -->
                    <div class="tab-pane fade" id="en-pane" role="tabpanel">
                        <div class="mb-3">
                            <label for="title_en" class="form-label">Titel (EN)</label>
                            <input type="text" class="form-control" id="title_en" name="title_en" value="<%= post ? post.title_en : '' %>">
                        </div>
                        <div class="mb-3">
                            <label for="content_en" class="form-label">Inhalt (EN)</label>
                            <textarea class="form-control" id="content_en" name="content_en" rows="15"><%= post ? post.content_en : '' %></textarea>
                        </div>
                    </div>
                </div>
                 <button type="button" id="translateBtn" class="btn btn-secondary mb-3">Deutsch nach Englisch übersetzen</button>
            </div>

            <!-- Seitenleiste -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">Veröffentlichen</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="draft" <%= (post && post.status === 'draft') ? 'selected' : '' %>>Entwurf</option>
                                <option value="published" <%= (post && post.status === 'published') ? 'selected' : '' %>>Veröffentlicht</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Speichern</button>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">What's New</div>
                    <div class="card-body">
                         <textarea class="form-control" id="whatsnew" name="whatsnew" rows="3"><%= post ? post.whatsnew : '' %></textarea>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Medien</div>
                    <div class="card-body" id="media-sidebar" style="max-height: 300px; overflow-y: auto;">
                        <% if (media && media.length > 0) { %>
                            <div class="row row-cols-3 g-2">
                                <% media.forEach(file => { %>
                                    <% if (file.type && file.type.startsWith('image/')) { %>
                                        <div class="col">
                                            <img src="/uploads/<%= file.name %>" class="img-fluid rounded" style="cursor: pointer;" onclick="insertMedia('<%= file.name %>')">
                                        </div>
                                    <% } %>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <p class="text-muted">Keine Bilder in der Mediathek.</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- TinyMCE Rich-Text-Editor Skript -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const commonConfig = {
        plugins: 'code table lists link image',
        toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | indent outdent | bullist numlist | code | table | link image'
    };
    tinymce.init({ ...commonConfig, selector: 'textarea#content_de' });
    tinymce.init({ ...commonConfig, selector: 'textarea#content_en' });

    // Funktion zum Einfügen von Medien
    window.insertMedia = (filename) => {
        const activeEditor = tinymce.activeEditor;
        if (activeEditor) {
            activeEditor.execCommand('mceInsertContent', false, `<img src="/uploads/${filename}" alt="" style="max-width: 100%;">`);
        }
    };

    // Übersetzungs-Funktion
    const translateBtn = document.getElementById('translateBtn');
    if(translateBtn) {
        translateBtn.addEventListener('click', async () => {
            const titleDe = document.getElementById('title_de').value;
            const contentDe = tinymce.get('content_de').getContent();
            
            translateBtn.disabled = true;
            translateBtn.textContent = 'Übersetze...';

            try {
                const response = await fetch('/admin/api/translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'CSRF-Token': '<%= csrfToken %>'
                    },
                    body: JSON.stringify({ text: `Translate the following title and html content to English.\n\nTitle: ${titleDe}\n\nContent: ${contentDe}` })
                });
                const result = await response.json();
                
                // Annahme: Die API gibt ein JSON-Objekt zurück, das wir parsen müssen
                const translatedParts = JSON.parse(result.translation);

                document.getElementById('title_en').value = translatedParts.title || '';
                tinymce.get('content_en').setContent(translatedParts.content || '');

            } catch (error) {
                console.error('Translation error:', error);
                alert('Übersetzung fehlgeschlagen.');
            } finally {
                translateBtn.disabled = false;
                translateBtn.textContent = 'Deutsch nach Englisch übersetzen';
            }
        });
    }
  });
</script>

<%- include('partials/footer') %>
