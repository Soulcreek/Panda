<%- include('partials/header') %>
<%- include('partials/admin_nav') %>
<div class="container my-5">
  <h2 class="mb-3">AI Usage</h2>
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-2">Heute</h5>
          <p class="display-6 mb-0"><%= (typeof totalToday!=='undefined'? totalToday : 0) %></p>
          <div class="text-muted small">Gesamt Calls (alle Endpoints)</div>
        </div>
      </div>
    </div>
    <div class="col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>Verteilung heute</strong>
          <a href="/admin/ai-usage" class="btn btn-sm btn-outline-secondary">Aktualisieren</a>
        </div>
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead class="table-light"><tr><th>Endpoint</th><th class="text-end">Calls</th></tr></thead>
            <tbody>
              <% if(Array.isArray(today) && today.length){ today.forEach(r=>{ %>
                <tr><td><code><%= r.endpoint %></code></td><td class="text-end"><%= r.calls %></td></tr>
              <% }) } else { %>
                <tr><td colspan="2" class="text-center text-muted">Keine heutigen Calls</td></tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="card shadow-sm mt-4">
    <div class="card-header"><strong>Historie (letzte 14 Tage)</strong></div>
    <div class="table-responsive" style="max-height:420px; overflow:auto;">
      <table class="table table-sm mb-0">
        <thead class="table-light"><tr><th>Datum</th><th>Endpoint</th><th class="text-end">Calls</th></tr></thead>
        <tbody>
          <% if(Array.isArray(history) && history.length){ history.forEach(r=>{ %>
            <tr><td><%= r.day.toISOString ? r.day.toISOString().slice(0,10) : (r.day) %></td><td><code><%= r.endpoint %></code></td><td class="text-end"><%= r.calls %></td></tr>
          <% }) } else { %>
            <tr><td colspan="3" class="text-center text-muted">Keine Daten</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card shadow-sm mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Detail Log (letzte 14 Tage – max 1000 Einträge)</strong>
      <span class="badge bg-secondary"><%= (log||[]).length %></span>
    </div>
    <div class="table-responsive" style="max-height:480px; overflow:auto;">
      <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:150px;">Zeit</th>
            <th style="width:110px;">Endpoint</th>
            <th>Prompt (Auszug, 400 Zeichen)</th>
            <th style="width:70px;" class="text-end">Zeichen</th>
            <th style="width:70px;" class="text-end">Fehler</th>
            <th style="width:60px;"></th>
          </tr>
        </thead>
        <tbody>
          <% if(Array.isArray(log) && log.length){ log.forEach(r=>{ %>
            <tr data-id="<%= r.id %>">
              <td class="text-nowrap"><%= (r.created_at instanceof Date) ? r.created_at.toISOString().replace('T',' ').slice(0,19) : r.created_at %></td>
              <td><code><%= r.endpoint %></code></td>
              <td style="max-width:600px; white-space:pre-wrap; font-family: var(--bs-font-monospace); font-size: .75rem;">
                <%= r.prompt_snippet %>
              </td>
              <td class="text-end"><%= r.response_chars || '' %></td>
              <td class="text-end"><%= r.error_message ? 'Ja' : '' %></td>
              <td class="text-end"><button type="button" class="btn btn-sm btn-outline-primary ai-log-detail" data-id="<%= r.id %>"><i class="bi bi-search"></i></button></td>
            </tr>
          <% }) } else { %>
            <tr><td colspan="5" class="text-center text-muted">Keine Log-Daten</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
    <div class="card-footer small text-muted">
      Prompt gekürzt auf 400 Zeichen. Response Länge = Anzahl Zeichen (nach Parsing). Fehlerdetails werden separat im Server-Log ausgegeben.
    </div>
  </div>
  <div class="alert alert-info small mt-4">
    Tageslimit basiert auf <code>ai_config.max_daily_calls</code>. Bei Erreichen blockiert der Service neue Aufrufe (Fehler: AI Tageslimit erreicht).
  </div>
</div>
<%- include('partials/footer') %>
<div class="modal fade" id="aiLogDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">AI Log Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="small text-muted mb-2" id="aiLogMeta"></div>
        <h6>Prompt</h6>
        <pre class="bg-light p-2 border rounded" style="max-height:240px; overflow:auto; font-size:.75rem;" id="aiLogPrompt"></pre>
        <h6 class="mt-3">Response (Raw gekürzt)</h6>
        <pre class="bg-light p-2 border rounded" style="max-height:240px; overflow:auto; font-size:.75rem;" id="aiLogResponse"></pre>
        <div class="mt-2" id="aiLogErrorWrap" style="display:none;">
          <div class="alert alert-danger py-1 mb-0 small" id="aiLogError"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnCopyPrompt">Prompt kopieren</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnCopyResponse">Response kopieren</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const rowsBtn = document.querySelectorAll('.ai-log-detail');
  const modalEl=document.getElementById('aiLogDetailModal');
  if(!modalEl) return;
  let bsModal;
  function ensureModal(){ if(!bsModal){ bsModal = new bootstrap.Modal(modalEl); } return bsModal; }
  async function loadDetail(id, btn){
    const origHtml = btn.innerHTML; btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>';
    try {
      const resp = await fetch('/admin/ai-usage/log/'+id);
      const data = await resp.json();
      if(!resp.ok) throw new Error(data.error||('HTTP '+resp.status));
      document.getElementById('aiLogMeta').textContent = 'ID '+data.id+' • Endpoint '+data.endpoint+' • '+(data.created_at||'');
      document.getElementById('aiLogPrompt').textContent = data.prompt||'';
      document.getElementById('aiLogResponse').textContent = data.response_raw||('[Keine Raw Response gespeichert]');
      const errWrap=document.getElementById('aiLogErrorWrap');
      const errBox=document.getElementById('aiLogError');
      if(data.error_message){ errWrap.style.display='block'; errBox.textContent=data.error_message; } else { errWrap.style.display='none'; }
      ensureModal().show();
    } catch(e){ alert('Detail laden fehlgeschlagen: '+e.message); }
    finally { btn.disabled=false; btn.innerHTML=origHtml; }
  }
  rowsBtn.forEach(b=> b.addEventListener('click', ()=> loadDetail(b.getAttribute('data-id'), b)) );
  function copy(id){ const el=document.getElementById(id); if(!el) return; navigator.clipboard.writeText(el.textContent||''); }
  document.getElementById('btnCopyPrompt').addEventListener('click',()=>copy('aiLogPrompt'));
  document.getElementById('btnCopyResponse').addEventListener('click',()=>copy('aiLogResponse'));
})();
</script>
