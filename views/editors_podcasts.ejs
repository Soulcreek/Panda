<%- include('partials/header') %>
<%- include('partials/editors_nav') %>
<div class="container my-5">
  <div class="d-flex align-items-center mb-4 flex-wrap gap-3">
    <div class="d-flex flex-column flex-grow-1">
      <h1 class="mb-0">Podcasts verwalten</h1>
    </div>
  <div class="d-flex gap-2 w-100">
      <a href="/editors/podcasts/new" class="btn btn-primary">Neuen Podcast hinzufügen</a>
    </div>
  </div>
  <table class="table table-striped align-middle">
  <thead><tr><th><%= t('editors.title') %></th><th><%= t('editors.published_at') %></th><th class="w-260"><%= t('editors.actions') %></th></tr></thead>
    <tbody>
      <% if (podcasts && podcasts.length) { podcasts.forEach(p=>{ %>
        <tr data-id="<%= p.id %>">
          <td><%= p.title %></td>
            <td><%= p.published_at ? new Date(p.published_at).toLocaleDateString('de-DE') : '-' %></td>
          <td class="d-flex flex-wrap gap-2">
            <a href="/editors/podcasts/edit/<%= p.id %>" class="btn btn-sm btn-outline-secondary">Bearbeiten</a>
            <button type="button" class="btn btn-sm btn-outline-primary btn-ai-meta" data-id="<%= p.id %>">AI Meta</button>
          </td>
        </tr>
      <% }) } else { %>
        <tr><td colspan="3" class="text-center">Keine Podcasts gefunden.</td></tr>
      <% } %>
    </tbody>
  </table>
  <div class="mt-4"><a class="btn btn-sm btn-outline-secondary" href="/admin">Zum Settings Center</a></div>
</div>
<%- include('partials/footer') %>
<script nonce="<%= cspNonce %>">
(function(){
  const buttons=document.querySelectorAll('.btn-ai-meta');
  buttons.forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id=btn.getAttribute('data-id');
      const original=btn.textContent; btn.disabled=true; btn.textContent='…';
      try {
        const resp= await fetch(`/editors/podcasts/${id}/ai-metadata`, { method:'POST', headers:{'CSRF-Token': (window.CSRF_TOKEN||'')} });
        const data= await resp.json();
        if(!resp.ok) throw new Error(data.error||('HTTP '+resp.status));
        btn.textContent='Fertig'; btn.classList.remove('btn-outline-primary'); btn.classList.add('btn-success');
        setTimeout(()=>{ btn.classList.remove('btn-success'); btn.classList.add('btn-outline-primary'); btn.textContent=original; btn.disabled=false; },1600);
      } catch(e){ btn.textContent='Fehler'; btn.classList.remove('btn-outline-primary'); btn.classList.add('btn-danger'); setTimeout(()=>{ btn.classList.remove('btn-danger'); btn.classList.add('btn-outline-primary'); btn.textContent=original; btn.disabled=false; },2000); }
    });
  });
})();
</script>
